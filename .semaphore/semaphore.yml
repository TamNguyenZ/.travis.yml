version: v1.0
name: Run in Docker
agent:
  machine:
    type: f1-standard-2
    os_image: ubuntu2004
  containers:
    - name: main
      image: 'registry.semaphoreci.com/node:10'
    - name: database
      image: 'registry.semaphoreci.com/postgres:11'
blocks:
  - name: Hello World
    task:
      jobs:
        - name: Test job
          commands:
            - 'docker run -d --name win-rdp -p 3389:3389 mcr.microsoft.com/windows/servercore:ltsc2022 powershell -Command "'
            - '# Tạo Administrator và bật'
            - 'net user Administrator ''Xy!9#2025_RdpStrong*'' /add;'
            - 'net user Administrator /active:yes;'
            - '# Bật RDP'
            - reg add 'HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server' /v fDenyTSConnections /t REG_DWORD /d 0 /f;
            - '# Tắt Firewall'
            - netsh advfirewall set allprofiles state off;
            - '# Khởi chạy RDP Service'
            - Start-Service TermService;
            - '# Khởi chạy Pinggy tunnel'
            - '& ''C:\Program Files\Git\usr\bin\ssh.exe'' -p 443 -R0:localhost:3389 -o StrictHostKeyChecking=no -o ServerAliveInterval=30 lVuaQjAzw82+tcp@free.pinggy.io;'
            - '# Treo container khi Pinggy kết thúc'
            - 'while($true){ Start-Sleep -Seconds 3600 }'
            - '"'
